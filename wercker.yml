box: node
services:
  - id: mongo
dev:
  steps:
    - npm-install
    - internal/watch:
        code: node 'src/server.js'
        reload: true

# Build definition
build:
  # The steps that will be executed on build
  steps:
    - script:
        code: export NODE_ENV='testing'
    # A step that executes `npm install` command
    - npm-install
    # A custom script step, name value is used in the UI
    # and the code value contains the command that get executed
    - script:
        name: ls
        code: npm install -g supervisor && npm start
deploy:
  steps:
    - npm-install
    - internal/docker-push:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        repository: davegri/librestock
        ports: "8080"
        cmd: cd /pipeline/output && npm install -g supervisor && npm start
    - add-ssh-key:
        keyname: DIGITAL_OCEAN
    - add-to-known_hosts:
        hostname: $LIBRESTOCK_SERVER_IP
    - script:
        name: pull latest image
        code: ssh root@$LIBRESTOCK_SERVER_IP docker pull davegri/librestock:latest
    - script:
        name: stop running container
        code: ssh root@$LIBRESTOCK_SERVER_IP docker stop librestock
    - script:
        name: remove stopped container
        code: ssh root@$LIBRESTOCK_SERVER_IP docker rm librestock
    - script:
        name: remove image behind stopped container
        code: ssh root@$LIBRESTOCK_SERVER_IP docker rmi davegri/librestock:current
    - script:
        name: tag newly pulled image
        code: ssh root@$LIBRESTOCK_SERVER_IP docker tag davegri/librestock:latest davegri/librestock:current
    - script:
        name: run new container
        code: ssh root@$LIBRESTOCK_SERVER_IP docker run -d -p 8080:8080 --name librestock davegri/librestock:current
