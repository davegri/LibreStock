box: node
services:
  - id: mongo
dev:
  steps:
    - npm-install
    - internal/watch:
        code: node 'src/server.js'
        reload: true

# Build definition
build:
  # The steps that will be executed on build
  steps:
    - script:
        code: export NODE_ENV='testing'
    # A step that executes `npm install` command
    - npm-install
deploy:
  steps:
    - npm-install
    - script:
      name: install supervisor
      code: npm install -g supervisor
    - internal/docker-push:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        repository: davegri/librestock
        ports: "5000"
        cmd: /bin/bash -c "cd /pipeline/source && supervisor --watch ./src src/server.js"

    - add-ssh-key:
        keyname: DIGITAL_OCEAN
    - add-to-known_hosts:
        hostname: $LIBRESTOCK_SERVER_IP
    - script:
        name: pull latest image
        code: ssh root@$LIBRESTOCK_SERVER_IP docker pull davegri/librestock:latest
    - script:
        name: stop running container
        code: ssh root@$LIBRESTOCK_SERVER_IP docker stop librestock || echo 'failed to stop running container'
    - script:
        name: remove stopped container
        code: ssh root@$LIBRESTOCK_SERVER_IP docker rm librestock || echo 'failed to remove stopped container'
    - script:
        name: remove image behind stopped container
        code: ssh root@$LIBRESTOCK_SERVER_IP docker rmi davegri/librestock:current || echo 'failed to remove image behind stopped container'
    - script:
        name: tag newly pulled image
        code: ssh root@$LIBRESTOCK_SERVER_IP docker tag davegri/librestock:latest davegri/librestock:current
    - script:
        name: run new container
        code: ssh root@$LIBRESTOCK_SERVER_IP docker run --link mongoDB:mongodb -d -p 5000:8080 --name librestock davegri/librestock:current
    - script:
        name: restart nginx
        code: ssh root@$LIBRESTOCK_SERVER_IP docker restart nginx || docker run -d --name nginx -p 8080:80 --link librestock:nodejs davegri/librestock-nginx
